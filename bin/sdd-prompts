#!/usr/bin/env python3
import sys, json
from pathlib import Path
from datetime import datetime


def read_text(p: Path) -> str:
    try:
        return p.read_text(encoding="utf-8").strip()
    except FileNotFoundError:
        return ""


def short_description(full: str, limit: int = 240) -> str:
    s = " ".join(full.strip().split())
    return s[:limit] + ("…" if len(s) > limit else "")


def render_template(tpl: str, values: dict) -> str:
    # Minimal {{VAR}} replace (no conditionals/loops)
    out = tpl
    for k, v in values.items():
        out = out.replace("{{" + k + "}}", v)
    return out


def main():
    if len(sys.argv) != 2:
        print("Usage: bin/sdd-prompts <project-root-with-.sdd>", file=sys.stderr)
        sys.exit(1)

    base = Path(sys.argv[1]).resolve()
    if not base.exists():
        print(f"Not found: {base}", file=sys.stderr)
        sys.exit(1)

    sdd_dir = base / ".sdd"
    if not sdd_dir.exists():
        print("Error: .sdd directory not found. Run bin/sdd-init in your project first.", file=sys.stderr)
        sys.exit(1)

    templates_dir = Path(__file__).resolve().parent.parent / "templates"
    cfg_path = sdd_dir / "config.json"
    if not cfg_path.exists():
        print(f"Missing config: {cfg_path}", file=sys.stderr)
        sys.exit(1)
    cfg = json.loads(cfg_path.read_text())
    project_name = cfg.get("project_name", base.name)
    tech_stack = cfg.get("tech_stack", "")
    domain = cfg.get("domain", "")
    year = cfg.get("year", str(datetime.now().year))

    project_md = read_text(sdd_dir / "project.md")
    prompts_dir = sdd_dir / "prompts"

    base_values = {
        "PROJECT_NAME": project_name,
        "PROJECT_DESCRIPTION": short_description(project_md or ""),
        "PROJECT_DESCRIPTION_CONTENT": project_md or "",
        "TECH_STACK": tech_stack,
        "DOMAIN": domain,
        "YEAR": str(year),
    }

    prompts_dir.mkdir(parents=True, exist_ok=True)

    mapping = [
        ("research_template.md", "01_research.prompt.md"),
        ("architect_template.md", "02_architect.prompt.md"),
        ("agent_template.md", "03_agent.prompt.md"),
    ]

    for tpl_name, out_name in mapping:
        tpl_path = templates_dir / tpl_name
        if not tpl_path.exists():
            print(f"WARN: missing template {tpl_path}")
            continue
        tpl = read_text(tpl_path)
        rendered = render_template(tpl, base_values)
        (prompts_dir / out_name).write_text(rendered, encoding="utf-8")
        print(f"✅ {out_name}")

    print("\nDone. Open the generated prompts and paste them into your AI tool.")


if __name__ == "__main__":
    main()
