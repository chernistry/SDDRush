#!/usr/bin/env python3
import sys, json
from pathlib import Path
from datetime import datetime


def read_text(p: Path) -> str:
    try:
        return p.read_text(encoding="utf-8").strip()
    except FileNotFoundError:
        return ""


def short_description(full: str, limit: int = 240) -> str:
    s = " ".join(full.strip().split())
    return s[:limit] + ("…" if len(s) > limit else "")


def render_template(tpl: str, values: dict) -> str:
    # Minimal {{VAR}} replace (no conditionals/loops)
    out = tpl
    for k, v in values.items():
        out = out.replace("{{" + k + "}}", v)
    return out


def main():
    if len(sys.argv) != 2:
        print("Usage: bin/sdd-prompts <path>  (either tasks/<name> dir or a project root with .sdd)", file=sys.stderr)
        sys.exit(1)

    base = Path(sys.argv[1]).resolve()
    if not base.exists():
        print(f"Not found: {base}", file=sys.stderr)
        sys.exit(1)

    # Detect mode
    is_single_project = (base / ".sdd").exists()
    if is_single_project:
        project_root = base
        sdd_dir = project_root / ".sdd"
        templates_dir = Path(__file__).resolve().parent.parent / "templates"
        cfg_path = sdd_dir / "config.json"
        if not cfg_path.exists():
            print(f"Missing config: {cfg_path}", file=sys.stderr)
            sys.exit(1)
        cfg = json.loads(cfg_path.read_text())
        project_name = cfg.get("project_name", project_root.name)
        tech_stack = cfg.get("tech_stack", "")
        domain = cfg.get("domain", "")
        year = cfg.get("year", str(datetime.now().year))

        project_md = read_text(sdd_dir / "project.md")
        best_practices_md = read_text(sdd_dir / "best_practices.md") or "TODO: paste research results here"
        architect_md = read_text(sdd_dir / "architect.md") or "TODO: paste the generated architecture specification here"
        coding_rules_md = read_text(sdd_dir / "coding_rules.md") or "TODO: paste the generated coding rules here"
        prompts_dir = sdd_dir / "prompts"
    else:
        task_dir = base
        project_root = task_dir.parent.parent  # .. / .. from tasks/<name>
        templates_dir = project_root / "templates"
        cfg_path = task_dir / "config.json"
        if not cfg_path.exists():
            print(f"Missing config: {cfg_path}", file=sys.stderr)
            sys.exit(1)
        cfg = json.loads(cfg_path.read_text())
        project_name = cfg.get("project_name", task_dir.name)
        tech_stack = cfg.get("tech_stack", "")
        domain = cfg.get("domain", "")
        year = cfg.get("year", str(datetime.now().year))

        project_md = read_text(task_dir / "input" / "project.md")
        best_practices_md = read_text(task_dir / "research" / "best_practices.md") or "TODO: paste research results here"
        architect_md = read_text(task_dir / "spec" / "architect.md") or "TODO: paste the generated architecture specification here"
        coding_rules_md = read_text(task_dir / "spec" / "coding_rules.md") or "TODO: paste the generated coding rules here"
        prompts_dir = task_dir / "prompts"

    base_values = {
        "PROJECT_NAME": project_name,
        "PROJECT_DESCRIPTION": short_description(project_md or ""),
        "PROJECT_DESCRIPTION_CONTENT": project_md or "",
        "TECH_STACK": tech_stack,
        "DOMAIN": domain,
        "YEAR": str(year),
        "BEST_PRACTICES_CONTENT": best_practices_md,
        "ARCHITECT_CONTENT": architect_md,
        "CODING_RULES_CONTENT": coding_rules_md,
    }

    prompts_dir.mkdir(parents=True, exist_ok=True)

    mapping = [
        ("task_solver_template.md", "00_task_solver.prompt.md"),
        ("solution_ideation_template.md", "00_solution_ideation.prompt.md"),
        ("research_template.md", "01_research.prompt.md"),
        ("architect_template.md", "02_architect.prompt.md"),
        ("coding_rules_template.md", "03_coding_rules.prompt.md"),
        ("agent_template.md", "04_agent.prompt.md"),
    ]

    for tpl_name, out_name in mapping:
        tpl_path = templates_dir / tpl_name
        if not tpl_path.exists():
            print(f"WARN: missing template {tpl_path}")
            continue
        tpl = read_text(tpl_path)
        rendered = render_template(tpl, base_values)
        (prompts_dir / out_name).write_text(rendered, encoding="utf-8")
        print(f"✅ {out_name}")

    print("\nDone. Open the generated prompts and paste them into your AI tool.")


if __name__ == "__main__":
    main()
