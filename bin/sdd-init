#!/usr/bin/env bash
set -euo pipefail

# Initialize Single-Project SDD layout inside an existing directory.
# Usage: bin/sdd-init [<project-dir>] [--path|-p <dir>] [--stack "Python/FastAPI"] [--domain "web"] [--year 2025]

TARGET_DIR="$(pwd)"
STACK=""
DOMAIN=""
YEAR="$(date +%Y)"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --path|-p) TARGET_DIR="$2"; shift 2;;
    --stack) STACK="$2"; shift 2;;
    --domain) DOMAIN="$2"; shift 2;;
    --year) YEAR="$2"; shift 2;;
    --*) echo "Unknown option: $1" >&2; exit 1;;
    *) TARGET_DIR="$1"; shift;;
  esac
done

mkdir -p "$TARGET_DIR/.sdd/prompts" "$TARGET_DIR/.sdd/backlog/tickets/open" "$TARGET_DIR/.sdd/backlog/tickets/closed"

PROJECT_NAME="$(basename "$TARGET_DIR")"

cat > "$TARGET_DIR/.sdd/config.json" <<JSON
{
  "project_name": "$PROJECT_NAME",
  "tech_stack": "$STACK",
  "domain": "$DOMAIN",
  "year": "$YEAR"
}
JSON

if [[ ! -f "$TARGET_DIR/.sdd/project.md" ]]; then
cat > "$TARGET_DIR/.sdd/project.md" <<MD
# Project Description

Briefly describe the task/project: goals, constraints, audience. 3‚Äì5 sentences is enough to start.

## Core
- Primary goal: ...
- Users/personas: ...
- Key constraints (tech, org, compliance): ...

## Definition of Done
List 5‚Äì10 concrete conditions that must be true when the project is ‚ÄúDone‚Äù (functional and non‚Äëfunctional).
- Functional outcomes (what users can do): ...
- Quality attributes (performance, reliability, security, UX): ...
- Process constraints (tests, documentation, release criteria): ...

## Non‚Äëfunctional Requirements (optional)
- Performance / latency / throughput: ...
- Availability / reliability / SLOs: ...
- Security / compliance: ...
- Observability / operations: ...
MD
fi

echo "‚úÖ SDD initialized in $TARGET_DIR (.sdd/prompts + .sdd/backlog/tickets/)"
echo ""
echo "üìã Next steps:"
echo "1. Edit .sdd/project.md (describe your project)"
echo "2. Run: python bin/sdd-prompts \"$TARGET_DIR\""
echo "3. Follow the 3-step flow:"
echo "   ‚Üí Step 1: Research (01_research.prompt.md ‚Üí best_practices.md)"
echo "   ‚Üí Step 2: Architect (02_architect.prompt.md ‚Üí architect.md + tickets)"
echo "   ‚Üí Step 3: Agent (03_agent.prompt.md ‚Üí implement tickets)"

# After initialization, check what's been completed
if [[ -f "$TARGET_DIR/.sdd/best_practices.md" ]]; then
  echo "   ‚úÖ Research completed"
else
  echo "   ‚è≥ Research pending"
fi

if [[ -f "$TARGET_DIR/.sdd/architect.md" ]]; then
  echo "   ‚úÖ Architecture completed"
else
  echo "   ‚è≥ Architecture pending"
fi

OPEN_TICKETS=$(find "$TARGET_DIR/.sdd/backlog/tickets/open" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
CLOSED_TICKETS=$(find "$TARGET_DIR/.sdd/backlog/tickets/closed" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
if [[ $OPEN_TICKETS -gt 0 || $CLOSED_TICKETS -gt 0 ]]; then
  echo "   üìù Tickets: $CLOSED_TICKETS closed, $OPEN_TICKETS open"
fi
